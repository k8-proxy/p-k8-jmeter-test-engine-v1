# 100k traffic generation

## The system overview

The traffic to the ICAP server is generated by working PODs running on dedicated JMeter nodes within a Kubernetes cluster. Along with the working Nodes/Pods, the cluster setup includes a Minio File Server, an InfluxDB Metrics Server, and a Grafana server with the corresponding dashboard(s).

![traffic](docs/pngs/jmeter-test.png)

Each of the pods runs an instance of JMeter with X number of threads where each of the threads emulates the specified ICAP server user. So, "users" get files from the Minio file server, send those to the ICAP server to be processed/rebuild and then upload the rebuilt files back to the Minio file server. The metrics of the operations are gathered by JMeter and uploaded to InfluxDB. Grafana gets those metrics from InfluxDB and visualizes those in the dashboard.
Also, JMeter logs generated on the PODs are uploaded to the Minio server for further analysis.

## 1. Prerequisites

- An MS Azure cluster that can autoscale to have a sufficient number of nodes to run the test.
- Python 3.8 or higher installed on your local machine

## 2. Setting up the node pools
For a detailed instruction to perform the step see ["Manual AKS Creation"](https://github.com/k8-proxy/p-k8-jmeter-test-engine/blob/master/ManualAKSCreation.MD)

## 3. Setting up the common resources
Create Minio, Influxdb, and Grafana services in the cluster.
Follow the instructions at ["Deploy applications to K8s cluster"](https://github.com/k8-proxy/p-k8-jmeter-test-engine/tree/master/kubernetes/common_resources)

### 3.1 Influx JMeter Database
The cluster InfluxDB deployment must have a database called JMeter
To create it enter the bash shell of the Influx DB pod
```
    kubectl exec -it <influxdb pod> -- bash
```
Then create the DB with the following commands
```
    # influx
    > database create jmeter
    > exit
    # exit
```

### 3.2 The Grafana dashboard
To reflect data changes in influx JMeter DB import the [Grafana dashboard](https://github.com/k8-proxy/p-k8-jmeter-test-engine/blob/master/src/grafana_dashboards/ICAP-Dashboard-4-grafana.json) to the Grafana deployed within the cluster

## 4. Configuring and running the JMeter PODs
Configuring and running the JMeter PODs is performed by [Create Stack](https://github.com/k8-proxy/p-k8-jmeter-test-engine/blob/master/src/controller/docker-jmeter-c-icap/create_stack.py) Python3 script.
For detailed instructions on running the script see the following [README](https://github.com/k8-proxy/p-k8-jmeter-test-engine/tree/master/src/controller/docker-jmeter-c-icap)
