# 100k traffic generation

## The system overview

The traffic to the ICAP server is generated by working PODs running on dedicated Nodes in a Kubernetes cluster. Besides the working Nodes/Pods, the cluster setup includes a Minio File Server, InfluxDB Metrics Server, and a Grafana server with a corresponding dashboard.

![traffic](pngs/jmeter-test.png)

Each of the pods runs an instance of JMeter with X number of threads where each of the threads corresponds to a real user. So, "users" get files from the Minio file server, send those to the ICAP server to be processed/rebuild and then upload the rebuilt files back to the Minio file server. The metrics of the operations are gathered by JMeter and uploaded to InfluxDB. Grafana gets those metrics from InfluxDB and visualizes those in the dashboard.

## 1. Prerequisites

An MS Azure cluster that allows the utilization of node pools with a sufficient number of pods.
The whole number of working pods with X number of concurrent threads per pod is `100 000 / X`
The number of concurrent threads is defined by the following line

```
    <stringProp name="ThreadGroup.num_threads">X</stringProp>
```
in `.../src/controller/docker-jmeter-c-icap/ICAP-POC_s3.jmx`

## 2. Setting up the node pools
The details instruction for this step is located at ManualAKSCreation.MD

## 3. Setting up the common resources
Create Minio, Influxdb, and Grafana services in the cluster
Follow instructions at kubernetes/common_resources/README.md

### 3.1 Influx JMeter Database
The cluster InfluxDB deployment must have a database called JMeter
To create it enter the bash shell of the influxdb pod
```
    kubectl exec -it <influxdb pod> -- bash
```
Then create the DB with the following commands
```
    # influx
    > database create jmeter
    > exit
    # exit
```

### 3.2 The Grafana dashboard
The Grafana dashboard that reflects data changes in influx JMeter DB is located at /src/grafana_dashboards/ICAP-Dashboard-4-grafana.json
Import it to the Grafana cluster deployment

### 3.3 Input files in Minio
Make sure your Minio deployment has input files in the `input` bucket

## 4. Configuring and running the working pods
As mentioned in the Prerequisites section, the number of necessary working pods is determined by the following `100 000 / X` where is the number of concurrent threads in `.../src/controller/docker-jmeter-c-icap/ICAP-POC_s3.jmx`

The current settings have been tested with 25 concurrent threads per pod. This means that to generate 100K traffic 4000 pods will be necessary

In `.../src/controller/docker-jmeter-c-icap/jmeter-job-tmpl.yaml` change `parallelism` value to 4000. 
In your PowerShell navigate to `.../src/controller/docker-jmeter-c-icap` folder. Run the following command:
```
    PowerShell -ExecutionPolicy ByPass -File run.ps1 ICAP-POC_s3.jmx files.txt 1
```

